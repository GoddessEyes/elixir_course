# Record

Запись (Record) -- важная структура данных для Эрланг, но в Эликсир она используется редко. Обычно она используется в случаях, когда нужно работать с Эрланг библиотекой, в АПИ которой используются Record.

В Эликсир разработке используется много Эрланг библиотек. Популярные библиотеки имеют Эликсир обертки, которые адаптируют АПИ в более удобный для Эликсир вид. Менее популярные библиотеки могут не иметь таких оберток, и тогда придется иметь дело с их АПИ, и в том числе иметь дело с Record.

Это не единственная причина, почему Record включены в курс. Но об этом ниже.

Чтобы понять, что такое Record, нужно вернуться к кортежам.

Кортеж можно рассматривать как урезаную KV структуру, из которой убрали Key и оставили только Value. Мы пользовались такими структурами в начале курса:

```
{:point, x1, y1}
{:rect, left_top, right_bottom}
```
Это вполне работает, когда у нас есть 2-3 значения, и ключи понятны из контекста. 4 значения работают уже хуже:
```
{:user, 1, "Bob", 23}
```
"Bob" -- понятно, имя.
1 -- ну тут должно быть id, значит это id.
А 23 -- это что?

5, 6 и больше значений работают совсем плохо.

И тут на помощь приходит Record. Это синтаксический сахар поверх кортежа, который добавляет отсутствующие ключи. Правда добавляет только в исходном коде, а в скомпилированном байткоде ключей уже нет. На этапе компиляции все Record превращаются в обычные кортежи.


## Расмотрим пример

Смоделируем наш любимый event еще раз, используя Record:
lib/model/record_event.ex

В iex консоли мы видим кортежи:
```
iex(1)> RecordExample.create
{:event, "Team Meeting", ~U[2021-03-10 19:40:00.000000Z],
 {:location, {:address, "Belarus", "Minsk", "Partizanskij pr", 178},
  {:room, 6, 610}},
 [
   {:participant, :human, "Helen", :project_manager},
   {:participant, :cat, "Tihon", :cate}
 ], [{:topic, :medium, "buying food for cat"}]}
```

Модуль Record автоматически создает макросы, позволяющие извлекать данные по ключу:
```
> import Model.RecordEvent.Event
Model.RecordEvent.Event
> event(ev, :title)
"Team Meeting"

> import Model.RecordEvent.Location
Model.RecordEvent.Location
> loc = event(ev, :location)
{:location, {:address, "Belarus", "Minsk", "Partizanskij pr", 178},
 {:room, 6, 610}}
> location(loc, :room)
{:room, 6, 610}
```

И модифицировать данные по ключу:
```
> ev = event(ev, title: "Food for cat")
{:event, "Food for cat", ~U[2021-03-10 19:40:00.000000Z],

> import Model.RecordEvent.Room
Model.RecordEvent.Room
> rm = location(loc, :room)
{:room, 6, 610}
> rm = room(rm, number: 611)
{:room, 6, 611}
> loc = location(loc, room: rm)
{:location, {:address, "Belarus", "Minsk", "Partizanskij pr", 178},
 {:room, 6, 611}}
> ev = event(ev, location: loc)
{:event, "Food for cat", ~U[2021-03-10 19:40:00.000000Z],
 {:location, {:address, "Belarus", "Minsk", "Partizanskij pr", 178},
  {:room, 6, 611}},
 [
   {:participant, :human, "Helen", :project_manager},
   {:participant, :cat, "Tihon", :cate}
 ], [{:topic, :medium, "buying food for cat"}]}
```


## Но зачем нам это все, если есть Struct?

Есть две причины: идеология и производительность.


### Идеология

KV структуры, статические (фиксированный набор полей) и динамические.

Настоящий статических структур нет ни в Эрланге ни в Эликсире. Но есть по-разному удачные (или по-разному неудачные) попытки создать эти структуры на базе существующих.

В Эликсир создали Struct на базе Map, из-за чего структура на уровне абстракции языка считается статической, но по реализации остается динамической.

В Эрланг пошли другим путем, и создали Record на базе Tuple. Получился другой компромис с другими особенностями.

Struct только имитирует статическую структуру, и эту имитацию при желании можно обойти. Тогда как Record -- это по-настоящему статическая структура.


### Производительность

Кортежи представлены в памяти как структуры C.
Map представлены в памяти как ... TODO как что?

Преимущество: эффективно по CPU и по памяти.

Аналогия: protobuf vs json.
protobuf -- нет ключей, только значения -- экономия трафика.

Record -- экономия и памяти, и CPU.



### Недостатки Record

Нет информации об именах ключей в рантайме. Что сильно затрудняет создание чего-то похожего на Ecto или Phoenix. Попытки были (ChicagoBoss), но не взлетели.

Не работает с Ecto и Phoenix.

В Эликсире не так удобно пользоваться Record, как Struct. Нет модификации на разных уровнях вложенности.
